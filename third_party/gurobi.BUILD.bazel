"""Gurobi library for Bazel"""

load("@lucid//tools:make_var_substitution.bzl", "make_var_substitution")
load("@rules_cc//cc:defs.bzl", "cc_import", "cc_library")

licenses(["notice"])

filegroup(
    name = "libgurobi.so",
    srcs = glob(["lib/libgurobi*.so"], allow_empty = True, exclude = ["lib/libgurobi*_light.so"]),
)

filegroup(
    name = "libgurobi.dylib",
    srcs = glob(["lib/libgurobi*.dylib"], allow_empty = True, exclude = ["lib/libgurobi*_light.dylib"]),
)

filegroup(
    name = "gurobi.dll",
    srcs = glob(["bin/gurobi*.dll"], allow_empty = True, exclude = ["bin/gurobi*_light.dll"]),
)

filegroup(
    name = "gurobi.lib",
    srcs = glob(["lib/gurobi*.lib"], allow_empty = True, exclude = ["lib/gurobi_c++*.lib"]),
)

filegroup(
    name = "gurobi.netstandard.lib",
    srcs = glob(["lib/gurobi*.netstandard*.dll"], allow_empty = True),
)

filegroup(
    name = "gurobi_c++md.lib",
    srcs = select({
        "@lucid//tools:debug_build": glob(["lib/gurobi_c++mdd*.lib"], allow_empty = True),
        "//conditions:default": glob(["lib/gurobi_c++md*.lib"], allow_empty = True, exclude = ["lib/gurobi_c++mdd*.lib"]),
    }),
)

cc_import(
    name = "_gurobi_c_unix",
    hdrs = ["include/gurobi_c.h"],
    shared_library = ":libgurobi.so",
)

cc_import(
    name = "_gurobi_cpp_unix",
    hdrs = ["include/gurobi_c++.h", "include/gurobi_c.h"],
    static_library = "lib/libgurobi_c++.a",
)

cc_import(
    name = "_gurobi_c_macos",
    hdrs = ["include/gurobi_c.h"],
    shared_library = ":libgurobi.dylib",
)

cc_import(
    name = "_gurobi_cpp_macos",
    hdrs = ["include/gurobi_c++.h", "include/gurobi_c.h"],
    static_library = "lib/libgurobi_c++.a",
)

cc_import(
    name = "_gurobi_dll_windows",
    shared_library = ":gurobi.dll",
)

cc_import(
    name = "_gurobi_dll_netstandard_windows",
    shared_library = ":gurobi.netstandard.lib",
)

cc_import(
    name = "_gurobi_lib_windows",
    hdrs = ["include/gurobi_c++.h", "include/gurobi_c.h"],
    static_library = ":gurobi.lib",
)

cc_import(
    name = "_gurobi_lib_md_windows",
    static_library = ":gurobi_c++md.lib",
)

make_var_substitution(name = "env_vars")

cc_library(
    name = "gurobi",
    deps = select({
        "@platforms//os:windows": [":_gurobi_dll_windows", ":_gurobi_dll_netstandard_windows", ":_gurobi_lib_windows", ":_gurobi_lib_md_windows"],
        "@platforms//os:linux": [":_gurobi_c_unix", ":_gurobi_cpp_unix"],
        "@platforms//os:macos": [":_gurobi_c_macos", ":_gurobi_cpp_macos"],
    }, "Unsupported platform for Gurobi library"),
    includes = ["include"],
    visibility = ["//visibility:public"],
    linkopts = select({
        "@platforms//os:windows": [],
        "@platforms//os:linux": ["-Wl,-rpath,$(GUROBI_HOME)/lib"],
        "@platforms//os:macos": ["-Wl,-rpath,$(GUROBI_HOME)/lib"],
    }, "Unsupported platform for Gurobi library"),
    toolchains = [":env_vars"],
)
